<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>手当計算</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 16px; line-height: 1.4; }
    h1 { font-size: 18px; margin: 0 0 6px; }
    .sub { color:#555; font-size: 13px; margin: 0 0 12px; }
    .grid { display: grid; gap: 12px; grid-template-columns: 1fr; max-width: 1200px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; }
    label { display:block; font-size: 12px; color:#444; margin-top: 6px; }
    input, select { width: 100%; padding: 8px; border:1px solid #ccc; border-radius: 8px; font-size: 14px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; font-size: 13px; text-align: left; vertical-align: top; }
    th { background: #fafafa; position: sticky; top: 0; }
    .row-controls { display:flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    button { padding: 8px 10px; border:1px solid #ccc; border-radius: 8px; background:#fff; cursor:pointer; }
    button:hover { background:#f6f6f6; }
    .muted { color:#666; font-size: 12px; }
    .right { text-align:right; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .summary { display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .sumBox { border: 1px dashed #ccc; border-radius: 10px; padding: 10px; }
    .sumBox b { font-size: 18px; }
    .two { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .three { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }

    @media (max-width: 768px) {
      body { margin: 10px; }
      h1 { font-size: 16px; text-align: center; }
      .sub { text-align:center; }
      input, select { font-size: 16px; }

      table { display: block; }
      thead { display: none; }

      tbody tr {
        display: block;
        margin-bottom: 14px;
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 10px;
        background: #fff;
      }

      tbody td {
        display: flex;
        justify-content: space-between;
        border: none;
        padding: 6px 0;
        font-size: 14px;
      }

      tbody td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #555;
      }

      .sumBox b { font-size: 22px; }

      .summary {
        position: sticky;
        bottom: 0;
        background: #fff;
        padding: 10px;
        border-top: 2px solid #ddd;
        z-index: 10;
      }
    }
  </style>
</head>
<body>
  <h1 id="pageTitle">手当計算</h1>
  <div class="sub" id="pageSubtitle"></div>

  <div class="grid">

    <div class="card">
      <div class="three">
        <div>
          <label>何月分（締め：先月15日〜今月15日）</label>
          <input id="targetMonth" type="month" />
        </div>
        <div>
          <label>対象期間（自動）</label>
          <input id="periodText" class="mono" readonly />
        </div>
        <div class="row-controls" style="justify-content:flex-end; align-self:end;">
          <button id="applyMonth">この月に更新</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="three">
        <div>
          <label>モーニング手当（円/時）</label>
          <input id="morningRate" type="number" min="0" step="1" value="50" />
        </div>
        <div>
          <label>休日手当（土日・祝日）（円/時）</label>
          <input id="holidayRate" type="number" min="0" step="1" value="100" />
        </div>
        <div>
          <label>端数（15分単位）切り上げ許容（分）</label>
          <input id="roundingGrace" type="number" min="0" max="14" step="1" value="0" />
        </div>
      </div>

      <div class="two" style="margin-top:10px;">
        <div>
          <label>モーニング時間帯（開始）</label>
          <input id="morningStart" class="mono" value="600" />
          <div class="muted">例：600 / 6:00 / 0600</div>
        </div>
        <div>
          <label>モーニング時間帯（終了）</label>
          <input id="morningEnd" class="mono" value="900" />
          <div class="muted">例：900 / 9:00 / 0900</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row-controls" style="justify-content: space-between;">
        <div>
          <label style="margin:0;">祝日</label>
          <div class="muted">自動判定＋手動リスト（補正用）</div>
        </div>
        <div class="row-controls">
          <label class="muted" style="margin:0; display:flex; align-items:center; gap:8px;">
            <input id="useAutoHoliday" type="checkbox" checked style="width:auto; margin:0;" />
            自動判定
          </label>
          <button id="fillHoliday">期間の祝日を自動入力</button>
          <button id="addHoliday">追加</button>
          <button id="clearHoliday">全消し</button>
        </div>
      </div>

      <table id="holidayTable" style="margin-top:10px;">
        <thead>
          <tr>
            <th style="width:200px;">日付</th>
            <th style="width:90px;"></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <div class="row-controls" style="justify-content: space-between;">
        <div>
          <label style="margin:0;">特別日（+α）</label>
          <div class="muted">日付と加算（円/時）</div>
        </div>
        <div class="row-controls">
          <button id="addSpecial">追加</button>
          <button id="clearSpecial">全消し</button>
        </div>
      </div>

      <table id="specialTable" style="margin-top:10px;">
        <thead>
          <tr>
            <th style="width:200px;">日付</th>
            <th style="width:200px;">加算（円/時）</th>
            <th style="width:90px;"></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <div class="row-controls" style="justify-content: space-between;">
        <div>
          <label style="margin:0;">勤務</label>
          <div class="muted">出勤/総労働は「730」「615」でもOK（自動で「7:30」「6:15」に整形）</div>
        </div>
        <div class="row-controls">
          <button id="addRow">行を追加</button>
          <button id="clearRows">全消し</button>
        </div>
      </div>

      <table id="workTable" style="margin-top:10px;">
        <thead>
          <tr>
            <th style="width:140px;">日付</th>
            <th style="width:110px;">出勤</th>
            <th style="width:120px;">総労働</th>
            <th style="width:120px;">退勤</th>

            <th style="width:120px;">朝(h)</th>
            <th class="right" style="width:140px;">朝(円)</th>

            <th style="width:120px;">休日(h)</th>
            <th class="right" style="width:140px;">休日(円)</th>

            <th style="width:120px;">特別(h)</th>
            <th class="right" style="width:140px;">特別(円)</th>

            <th style="width:90px;"></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <label>集計</label>
      <div class="summary">
        <div class="sumBox">モーニング合計（円）<br><b id="sumMorning">0</b></div>
        <div class="sumBox">休日合計（円）<br><b id="sumHoliday">0</b></div>
        <div class="sumBox">特別合計（円）<br><b id="sumSpecial">0</b></div>
        <div class="sumBox">全部合計（円）<br><b id="sumAll">0</b></div>
      </div>
    </div>

  </div>

<script>
  const workTbody = document.querySelector("#workTable tbody");
  const specialTbody = document.querySelector("#specialTable tbody");
  const holidayTbody = document.querySelector("#holidayTable tbody");

  const morningRateEl = document.querySelector("#morningRate");
  const holidayRateEl = document.querySelector("#holidayRate");
  const roundingGraceEl = document.querySelector("#roundingGrace");
  const morningStartEl = document.querySelector("#morningStart");
  const morningEndEl = document.querySelector("#morningEnd");
  const useAutoHolidayEl = document.querySelector("#useAutoHoliday");

  const targetMonthEl = document.querySelector("#targetMonth");
  const periodTextEl = document.querySelector("#periodText");
  const pageTitleEl = document.querySelector("#pageTitle");
  const pageSubtitleEl = document.querySelector("#pageSubtitle");

  const sumMorningEl = document.querySelector("#sumMorning");
  const sumHolidayEl = document.querySelector("#sumHoliday");
  const sumSpecialEl = document.querySelector("#sumSpecial");
  const sumAllEl = document.querySelector("#sumAll");

  const pad2 = n => String(n).padStart(2,'0');
  const clamp = (n, lo, hi) => Math.max(lo, Math.min(hi, n));

  function ymd(d) {
    const y = d.getFullYear();
    const m = pad2(d.getMonth() + 1);
    const da = pad2(d.getDate());
    return `${y}-${m}-${da}`;
  }

  function formatJP(dateStr) {
    const [y,m,d] = dateStr.split("-").map(Number);
    return `${y}/${m}/${d}`;
  }

  function periodFromTargetMonth(yyyyMm) {
    const [y, m] = yyyyMm.split("-").map(Number);
    const end = new Date(y, m - 1, 15);
    const start = new Date(y, m - 2, 15);
    return { start, end };
  }

  let PERIOD = null;

  function setTargetMonth(yyyyMm) {
    PERIOD = periodFromTargetMonth(yyyyMm);
    const s = ymd(PERIOD.start);
    const e = ymd(PERIOD.end);
    periodTextEl.value = `${s} 〜 ${e}`;
    pageTitleEl.textContent = `${Number(yyyyMm.slice(0,4))}年${Number(yyyyMm.slice(5,7))}月分 手当計算`;
    pageSubtitleEl.textContent = `対象期間：${formatJP(s)} 〜 ${formatJP(e)}`;
    recalcAll();
  }

  function isInPeriod(dateStr) {
    if (!PERIOD) return true;
    const d = new Date(dateStr + "T00:00:00");
    const s = new Date(PERIOD.start); s.setHours(0,0,0,0);
    const e = new Date(PERIOD.end);   e.setHours(0,0,0,0);
    return d >= s && d <= e;
  }

  function normalizeDigits(s) {
    return String(s ?? "")
      .trim()
      .replace(/：/g, ":")
      .replace(/[０-９]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
  }

  // 730 / 0730 / 7:30 / 7 / 45 など → 分
  function parseTimeFlexible(str) {
    const s0 = normalizeDigits(str);
    if (!s0) return null;

    // すでに "H:MM" 形式
    const m1 = s0.match(/^(\d{1,2}):(\d{1,2})$/);
    if (m1) {
      const hh = Number(m1[1]);
      const mm = Number(m1[2]);
      if (hh < 0 || hh > 47 || mm < 0 || mm > 59) return null;
      return hh * 60 + mm;
    }

    // 数字だけ
    const digits = s0.replace(/\D/g, "");
    if (!digits) return null;

    if (digits.length <= 2) {
      // "7" -> 7:00 / "45" -> 0:45
      const n = Number(digits);
      if (digits.length === 1) return n * 60;
      if (digits.length === 2) return n; // 0:MM
    }

    // 3桁: 730 -> 7:30
    if (digits.length === 3) {
      const hh = Number(digits.slice(0,1));
      const mm = Number(digits.slice(1,3));
      if (mm > 59) return null;
      return hh * 60 + mm;
    }

    // 4桁以上: 0730 / 1230 -> 12:30（先頭4桁を採用）
    const d4 = digits.slice(0,4);
    const hh = Number(d4.slice(0,2));
    const mm = Number(d4.slice(2,4));
    if (hh < 0 || hh > 47 || mm < 0 || mm > 59) return null;
    return hh * 60 + mm;
  }

  function fmtHM(minutes) {
    const hh = Math.floor(minutes / 60);
    const mm = minutes % 60;
    return `${hh}:${pad2(mm)}`;
  }

  // 入力欄を "H:MM" に整形（解釈できる時だけ）
  function formatInputToHM(inputEl) {
    const mins = parseTimeFlexible(inputEl.value);
    if (mins == null) return;
    inputEl.value = fmtHM(mins);
  }

  function roundMinutesTo15(mins) {
    const grace = clamp(Number(roundingGraceEl.value || 0), 0, 14);
    const rem = mins % 15;
    if (rem === 0) return mins;
    const toNext = 15 - rem;
    if (toNext <= grace) return mins + toNext;
    return mins - rem;
  }

  function minutesToHoursRounded(mins) {
    return roundMinutesTo15(mins) / 60;
  }

  function isWeekend(dateStr) {
    const d = new Date(dateStr + "T00:00:00");
    const day = d.getDay();
    return day === 0 || day === 6;
  }

  function nthWeekdayOfMonth(year, month1to12, weekday0to6, nth) {
    const first = new Date(year, month1to12 - 1, 1);
    const firstW = first.getDay();
    const delta = (weekday0to6 - firstW + 7) % 7;
    const day = 1 + delta + (nth - 1) * 7;
    return new Date(year, month1to12 - 1, day);
  }

  function vernalEquinoxDay(year) {
    const day = Math.floor(20.8431 + 0.242194 * (year - 1980) - Math.floor((year - 1980) / 4));
    return new Date(year, 2, day);
  }
  function autumnalEquinoxDay(year) {
    const day = Math.floor(23.2488 + 0.242194 * (year - 1980) - Math.floor((year - 1980) / 4));
    return new Date(year, 8, day);
  }

  function buildJapanHolidaySet(year) {
    const set = new Set();
    set.add(`${year}-01-01`);
    set.add(`${year}-02-11`);
    set.add(`${year}-02-23`);
    set.add(`${year}-04-29`);
    set.add(`${year}-05-03`);
    set.add(`${year}-05-04`);
    set.add(`${year}-05-05`);
    set.add(`${year}-08-11`);
    set.add(`${year}-11-03`);
    set.add(`${year}-11-23`);

    set.add(ymd(nthWeekdayOfMonth(year, 1, 1, 2)));
    set.add(ymd(nthWeekdayOfMonth(year, 7, 1, 3)));
    set.add(ymd(nthWeekdayOfMonth(year, 9, 1, 3)));
    set.add(ymd(nthWeekdayOfMonth(year,10, 1, 2)));

    set.add(ymd(vernalEquinoxDay(year)));
    set.add(ymd(autumnalEquinoxDay(year)));

    const isHoliday = (d) => set.has(ymd(d));
    const run = () => {
      for (let m = 0; m < 12; m++) {
        for (let day = 1; day <= 31; day++) {
          const d = new Date(year, m, day);
          if (d.getMonth() !== m) continue;
          const key = ymd(d);
          if (!set.has(key)) continue;
          if (d.getDay() === 0) {
            let nd = new Date(d);
            do { nd.setDate(nd.getDate() + 1); } while (set.has(ymd(nd)));
            set.add(ymd(nd));
          }
        }
      }
      for (let m = 0; m < 12; m++) {
        for (let day = 2; day <= 30; day++) {
          const d = new Date(year, m, day);
          if (d.getMonth() !== m) continue;
          const prev = new Date(d); prev.setDate(prev.getDate() - 1);
          const next = new Date(d); next.setDate(next.getDate() + 1);
          if (!isHoliday(d) && isHoliday(prev) && isHoliday(next) && d.getDay() !== 0 && d.getDay() !== 6) {
            set.add(ymd(d));
          }
        }
      }
    };
    run(); run();
    return set;
  }

  function addHolidayRow(dateVal="") {
    const tr = document.createElement("tr");

    const tdDate = document.createElement("td");
    const inDate = document.createElement("input");
    inDate.type = "date";
    inDate.value = dateVal;
    tdDate.appendChild(inDate);

    const tdDel = document.createElement("td");
    const btn = document.createElement("button");
    btn.textContent = "削除";
    btn.addEventListener("click", () => { tr.remove(); recalcAll(); });
    tdDel.appendChild(btn);

    inDate.addEventListener("input", recalcAll);

    tr.append(tdDate, tdDel);
    holidayTbody.appendChild(tr);
  }

  function readManualHolidaySet() {
    const set = new Set();
    for (const tr of holidayTbody.querySelectorAll("tr")) {
      const date = tr.querySelector('input[type="date"]').value;
      if (date) set.add(date);
    }
    return set;
  }

  function clearHolidayRows() {
    holidayTbody.innerHTML = "";
  }

  function fillHolidayListForPeriod() {
    clearHolidayRows();
    if (!PERIOD) return;

    const map = new Map();
    map.set(PERIOD.start.getFullYear(), buildJapanHolidaySet(PERIOD.start.getFullYear()));
    map.set(PERIOD.end.getFullYear(), buildJapanHolidaySet(PERIOD.end.getFullYear()));

    const s = new Date(PERIOD.start); s.setHours(0,0,0,0);
    const e = new Date(PERIOD.end);   e.setHours(0,0,0,0);

    for (let d = new Date(s); d <= e; d.setDate(d.getDate() + 1)) {
      const key = ymd(d);
      const hs = map.get(d.getFullYear());
      if (hs && hs.has(key)) addHolidayRow(key);
    }
    recalcAll();
  }

  function addSpecialRow(dateVal="", rateVal="") {
    const tr = document.createElement("tr");

    const tdDate = document.createElement("td");
    const inDate = document.createElement("input");
    inDate.type = "date";
    inDate.value = dateVal;
    tdDate.appendChild(inDate);

    const tdRate = document.createElement("td");
    const inRate = document.createElement("input");
    inRate.type = "number";
    inRate.min = "0";
    inRate.step = "1";
    inRate.value = rateVal;
    tdRate.appendChild(inRate);

    const tdDel = document.createElement("td");
    const btn = document.createElement("button");
    btn.textContent = "削除";
    btn.addEventListener("click", () => { tr.remove(); recalcAll(); });
    tdDel.appendChild(btn);

    [inDate, inRate].forEach(el => el.addEventListener("input", recalcAll));
    tr.append(tdDate, tdRate, tdDel);
    specialTbody.appendChild(tr);
  }

  function readSpecials() {
    const map = new Map();
    for (const tr of specialTbody.querySelectorAll("tr")) {
      const date = tr.querySelector('input[type="date"]').value;
      const rate = Number(tr.querySelector('input[type="number"]').value || 0);
      if (date) map.set(date, rate);
    }
    return map;
  }

  function addWorkRow(dateVal="", startVal="", durVal="") {
    const tr = document.createElement("tr");

    const tdDate = document.createElement("td");
    tdDate.setAttribute("data-label", "日付");
    const inDate = document.createElement("input");
    inDate.type = "date";
    inDate.value = dateVal;
    tdDate.appendChild(inDate);

    const tdStart = document.createElement("td");
    tdStart.setAttribute("data-label", "出勤");
    const inStart = document.createElement("input");
    inStart.placeholder = "730";
    inStart.className = "mono";
    inStart.value = startVal;
    tdStart.appendChild(inStart);

    const tdDur = document.createElement("td");
    tdDur.setAttribute("data-label", "総労働");
    const inDur = document.createElement("input");
    inDur.placeholder = "630";
    inDur.className = "mono";
    inDur.value = durVal;
    tdDur.appendChild(inDur);

    const tdEnd = document.createElement("td");
    tdEnd.setAttribute("data-label", "退勤");
    tdEnd.className = "mono";

    const tdMorningH = document.createElement("td");
    tdMorningH.setAttribute("data-label", "朝(h)");
    tdMorningH.className = "mono";

    const tdMorningY = document.createElement("td");
    tdMorningY.setAttribute("data-label", "朝(円)");
    tdMorningY.className = "right mono";

    const tdHolidayH = document.createElement("td");
    tdHolidayH.setAttribute("data-label", "休日(h)");
    tdHolidayH.className = "mono";

    const tdHolidayY = document.createElement("td");
    tdHolidayY.setAttribute("data-label", "休日(円)");
    tdHolidayY.className = "right mono";

    const tdSpecialH = document.createElement("td");
    tdSpecialH.setAttribute("data-label", "特別(h)");
    tdSpecialH.className = "mono";

    const tdSpecialY = document.createElement("td");
    tdSpecialY.setAttribute("data-label", "特別(円)");
    tdSpecialY.className = "right mono";

    const tdDel = document.createElement("td");
    tdDel.setAttribute("data-label", "操作");
    const btn = document.createElement("button");
    btn.textContent = "削除";
    btn.addEventListener("click", () => { tr.remove(); recalcAll(); });
    tdDel.appendChild(btn);

    // blurで自動整形（入力中に邪魔しない）
    inStart.addEventListener("blur", () => { formatInputToHM(inStart); recalcAll(); });
    inDur.addEventListener("blur", () => { formatInputToHM(inDur); recalcAll(); });

    // これらも同様に整形
    morningStartEl.addEventListener("blur", () => { formatInputToHM(morningStartEl); recalcAll(); });
    morningEndEl.addEventListener("blur", () => { formatInputToHM(morningEndEl); recalcAll(); });

    [inDate, inStart, inDur].forEach(el => el.addEventListener("input", recalcAll));

    tr.append(
      tdDate, tdStart, tdDur, tdEnd,
      tdMorningH, tdMorningY,
      tdHolidayH, tdHolidayY,
      tdSpecialH, tdSpecialY,
      tdDel
    );
    workTbody.appendChild(tr);
  }

  function recalcAll() {
    const morningRate = Number(morningRateEl.value || 0);
    const holidayRate = Number(holidayRateEl.value || 0);

    const mStart = parseTimeFlexible(morningStartEl.value);
    const mEnd = parseTimeFlexible(morningEndEl.value);
    const morningStart = (mStart == null ? 6*60 : mStart);
    const morningEnd = (mEnd == null ? 9*60 : mEnd);

    const specials = readSpecials();
    const manualHoliday = readManualHolidaySet();
    const useAuto = useAutoHolidayEl.checked;

    const years = new Set();
    if (PERIOD) { years.add(PERIOD.start.getFullYear()); years.add(PERIOD.end.getFullYear()); }
    const autoMap = new Map();
    if (useAuto) for (const y of years) autoMap.set(y, buildJapanHolidaySet(y));

    const isAutoHoliday = (dateStr) => {
      const hs = autoMap.get(Number(dateStr.slice(0,4)));
      return hs ? hs.has(dateStr) : false;
    };

    let sumMorning = 0;
    let sumHoliday = 0;
    let sumSpecial = 0;

    for (const tr of workTbody.querySelectorAll("tr")) {
      const tds = tr.querySelectorAll("td");
      const dateStr = tds[0].querySelector('input[type="date"]').value;

      const startMin = parseTimeFlexible(tds[1].querySelector("input").value);
      const durMinRaw = parseTimeFlexible(tds[2].querySelector("input").value);

      const tdEnd = tds[3];
      const tdMorningH = tds[4];
      const tdMorningY = tds[5];
      const tdHolidayH = tds[6];
      const tdHolidayY = tds[7];
      const tdSpecialH = tds[8];
      const tdSpecialY = tds[9];

      tdEnd.textContent = "";
      tdMorningH.textContent = ""; tdMorningY.textContent = "";
      tdHolidayH.textContent = ""; tdHolidayY.textContent = "";
      tdSpecialH.textContent = ""; tdSpecialY.textContent = "";

      if (!dateStr || startMin == null || durMinRaw == null) continue;
      if (!isInPeriod(dateStr)) continue;

      const durMin = roundMinutesTo15(durMinRaw);
      const totalHours = durMin / 60;

      tdEnd.textContent = fmtHM(startMin + durMinRaw);

      const overlapStart = Math.max(startMin, morningStart);
      const overlapEnd = Math.min(startMin + durMinRaw, morningEnd);
      const overlapMinRaw = Math.max(0, overlapEnd - overlapStart);
      const morningHours = minutesToHoursRounded(overlapMinRaw);
      const morningYen = morningHours * morningRate;

      const holidayLike =
        isWeekend(dateStr) ||
        manualHoliday.has(dateStr) ||
        (useAuto && isAutoHoliday(dateStr));

      const holidayHours = holidayLike ? totalHours : 0;
      const holidayYen = holidayHours * holidayRate;

      const specialRate = specials.get(dateStr) ?? 0;
      const specialHours = specialRate > 0 ? totalHours : 0;
      const specialYen = specialHours * specialRate;

      tdMorningH.textContent = morningHours.toFixed(2);
      tdMorningY.textContent = Math.floor(morningYen).toString();

      tdHolidayH.textContent = holidayHours.toFixed(2);
      tdHolidayY.textContent = Math.floor(holidayYen).toString();

      tdSpecialH.textContent = specialHours.toFixed(2);
      tdSpecialY.textContent = Math.floor(specialYen).toString();

      sumMorning += morningYen;
      sumHoliday += holidayYen;
      sumSpecial += specialYen;
    }

    sumMorningEl.textContent = String(Math.floor(sumMorning));
    sumHolidayEl.textContent = String(Math.floor(sumHoliday));
    sumSpecialEl.textContent = String(Math.floor(sumSpecial));
    sumAllEl.textContent = String(Math.floor(sumMorning + sumHoliday + sumSpecial));
  }

  // init
  (function init() {
    const now = new Date();
    targetMonthEl.value = `${now.getFullYear()}-${pad2(now.getMonth()+1)}`;
    setTargetMonth(targetMonthEl.value);

    // 入力欄（モーニング時間帯）も blur 整形
    morningStartEl.addEventListener("blur", () => formatInputToHM(morningStartEl));
    morningEndEl.addEventListener("blur", () => formatInputToHM(morningEndEl));

    addWorkRow();
  })();

  // Buttons
  document.querySelector("#applyMonth").addEventListener("click", () => setTargetMonth(targetMonthEl.value));

  document.querySelector("#addRow").addEventListener("click", () => { addWorkRow(); recalcAll(); });
  document.querySelector("#clearRows").addEventListener("click", () => { workTbody.innerHTML = ""; addWorkRow(); recalcAll(); });

  document.querySelector("#addSpecial").addEventListener("click", () => { addSpecialRow("", ""); recalcAll(); });
  document.querySelector("#clearSpecial").addEventListener("click", () => { specialTbody.innerHTML = ""; recalcAll(); });

  document.querySelector("#addHoliday").addEventListener("click", () => { addHolidayRow(""); recalcAll(); });
  document.querySelector("#clearHoliday").addEventListener("click", () => { holidayTbody.innerHTML = ""; recalcAll(); });
  document.querySelector("#fillHoliday").addEventListener("click", () => fillHolidayListForPeriod());

  // Inputs
  [morningRateEl, holidayRateEl, roundingGraceEl, useAutoHolidayEl, targetMonthEl]
    .forEach(el => el.addEventListener("input", recalcAll));
</script>
</body>
</html>
